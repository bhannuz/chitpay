<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>AK Chit Funds - Portal</title>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
:root{
  --bg:#0a0f1e;--surface:#111827;--surface2:#1a2235;
  --accent:#f59e0b;--text:#f1f5f9;--muted:#64748b;
  --border:rgba(255,255,255,0.08);
  --gold:linear-gradient(135deg,#f59e0b,#fbbf24,#d97706);
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{font-family:'Sora',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;max-width:430px;margin:0 auto;overflow-x:hidden;}

/* TOPBAR */
.topbar{position:sticky;top:0;z-index:100;background:rgba(10,15,30,.97);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);padding:12px 20px;display:flex;align-items:center;justify-content:space-between;}
.brand-name{font-size:17px;font-weight:800;background:var(--gold);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.sync-badge{font-size:11px;font-weight:600;padding:4px 10px;border-radius:8px;transition:all .3s;}
.sync-badge.synced{background:rgba(16,185,129,.15);color:#34d399;border:1px solid rgba(16,185,129,.3);}

.page{display:none;animation:fadeUp .3s ease;}
.page.active{display:block;}
@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
.content{padding:20px 20px 170px;}

/* BOTTOM NAV */
.bottom-nav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:430px;background:rgba(17,24,39,.97);backdrop-filter:blur(20px);border-top:1px solid var(--border);z-index:100;}
.quick-add-bar{display:flex;gap:8px;padding:8px 12px;background:rgba(10,15,30,.95);}
.quick-btn{flex:1;display:flex;align-items:center;justify-content:center;gap:6px;padding:9px;border-radius:12px;font-size:12px;font-weight:700;cursor:pointer;border:1px solid;}
.quick-btn.member{background:rgba(245,158,11,.08);border-color:rgba(245,158,11,.3);color:var(--accent);}
.bottom-nav-btns{display:flex;padding:8px 0 calc(8px + env(safe-area-inset-bottom));}
.nav-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;cursor:pointer;}
.nav-label{font-size:10px;color:var(--muted);}
.nav-item.active .nav-label{color:var(--accent);}

/* COMMON */
.card{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:20px;margin-bottom:16px;}
.form-label{font-size:11px;color:var(--muted);font-weight:700;margin-bottom:8px;display:block;text-transform:uppercase;}
.form-input{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:13px 16px;color:var(--text);font-family:'Sora',sans-serif;font-size:14px;outline:none;}
.form-group{margin-bottom:14px;}

/* SEARCH RESULTS */
#search-results{display:none;position:absolute;top:100%;left:0;right:0;background:var(--surface2);border:1px solid var(--accent);border-radius:12px;z-index:1000;max-height:200px;overflow-y:auto;margin-top:4px;box-shadow:0 10px 25px rgba(0,0,0,0.5);}
.search-item{padding:12px;border-bottom:1px solid var(--border);cursor:pointer;}
.search-item:last-child{border-bottom:none;}

/* MODALS */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.8);backdrop-filter:blur(8px);z-index:200;display:none;align-items:flex-end;justify-content:center;}
.modal-overlay.open{display:flex;}
.modal{background:var(--surface);border-radius:24px 24px 0 0;width:100%;max-width:430px;padding:24px 20px calc(24px + env(safe-area-inset-bottom));border-top:1px solid var(--border);max-height:90vh;overflow-y:auto;}
.primary-btn{width:100%;background:var(--gold);border:none;border-radius:14px;padding:15px;color:#000;font-weight:700;cursor:pointer;margin-top:4px;}
.secondary-btn{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:14px;padding:13px;color:var(--text);cursor:pointer;margin-top:10px;}
</style>
</head>
<body>

<div class="topbar">
  <div class="brand-name">üèÜ AK Chit Funds</div>
  <div class="sync-badge synced" id="syncBadge">‚òÅÔ∏è Synced</div>
</div>

<div class="page active" id="page-home">
  <div class="content">
    <div style="margin-bottom:16px;">
      <div style="font-size:22px;font-weight:800;">Bhanu Prasad</div>
      <div style="font-size:12px;color:var(--muted);">Chit Fund Administrator</div>
    </div>

    <div class="card">
       <label class="form-label">Quick Stats</label>
       <div style="display:flex; gap:10px; justify-content:space-between;">
         <div><span id="st-members">0</span> Members</div>
         <div><span id="st-groups">0</span> Groups</div>
       </div>
    </div>

    <button class="primary-btn" onclick="openPaymentModal()" style="margin-bottom:20px;">üí≥ New Payment</button>
  </div>
</div>

<div class="modal-overlay" id="paymentModal">
  <div class="modal">
    <div style="font-size:18px; font-weight:700; margin-bottom:18px;">üí≥ Record Payment</div>
    
    <div class="form-group" style="position:relative;">
      <label class="form-label">Member Name</label>
      <input type="text" class="form-input" id="pay-member-search" placeholder="üîç Type to search members..." autocomplete="off" oninput="filterMemberSearch()" onfocus="showMemberResults()">
      <input type="hidden" id="pay-member-id">
      <div id="search-results"></div>
    </div>

    <div class="form-group">
      <label class="form-label">Group Name</label>
      <select class="form-input" id="pay-group" disabled><option value="">-- Select Group --</option></select>
    </div>

    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
        <div class="form-group">
            <label class="form-label">Chit Val (‚Çπ)</label>
            <input class="form-input" type="number" id="pay-chitval" oninput="calcBalance()">
        </div>
        <div class="form-group">
            <label class="form-label">Paid (‚Çπ)</label>
            <input class="form-input" type="number" id="pay-amount" oninput="calcBalance()">
        </div>
    </div>

    <div class="form-group">
      <label class="form-label">Balance (‚Çπ)</label>
      <input class="form-input" type="number" id="pay-balance" readonly style="opacity:.6;">
    </div>

    <button class="primary-btn" onclick="savePayment()">‚úì Save Payment</button>
    <button class="secondary-btn" onclick="closeModal('paymentModal')">Cancel</button>
  </div>
</div>

<nav class="bottom-nav">
  <div class="quick-add-bar">
    <div class="quick-btn member" onclick="alert('Open Add Member Modal')">‚ûï New Member</div>
  </div>
  <div class="bottom-nav-btns">
    <div class="nav-item active"><span class="nav-label">Home</span></div>
  </div>
</nav>

<script>
// DB CONFIG
const SB_URL='https://fxmulysdirqrkixdqusg.supabase.co';
const SB_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ4bXVseXNkaXJxcmtpeGRxdXNnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NDEzMTMsImV4cCI6MjA4NzQxNzMxM30.Vlptcq0oI5-oA4CtpshjqAvG_yEM-t1TuXfKXpfxgf4';
const H={'Content-Type':'application/json','apikey':SB_KEY,'Authorization':'Bearer '+SB_KEY,'Prefer':'return=representation'};

let members=[], groups=[], payments=[];

// FETCH DATA
async function init(){
  try {
    const rm = await fetch(`${SB_URL}/rest/v1/members?select=*`, {headers:H});
    members = await rm.json();
    document.getElementById('st-members').textContent = members.length;
    
    const rg = await fetch(`${SB_URL}/rest/v1/groups?select=*`, {headers:H});
    groups = await rg.json();
    document.getElementById('st-groups').textContent = groups.length;
  } catch(e) { console.error("Load failed", e); }
}

// SEARCH LOGIC
function showMemberResults() {
  document.getElementById('search-results').style.display = 'block';
  filterMemberSearch();
}

function filterMemberSearch() {
  const query = document.getElementById('pay-member-search').value.toLowerCase();
  const container = document.getElementById('search-results');
  const filtered = members.filter(m => m.name.toLowerCase().includes(query));

  container.innerHTML = filtered.map(m => `
    <div class="search-item" onclick="selectSearchMember('${m.id}', '${m.name.replace(/'/g, "\\'")}', '${m.group_name}')">
      <div style="font-weight:600;">${m.name}</div>
      <div style="font-size:10px; color:var(--muted);">${m.group_name || 'No Group'}</div>
    </div>
  `).join('');
}

function selectSearchMember(id, name, groupName) {
  document.getElementById('pay-member-id').value = id;
  document.getElementById('pay-member-search').value = name;
  document.getElementById('search-results').style.display = 'none';
  
  const gsel = document.getElementById('pay-group');
  gsel.innerHTML = `<option value="${groupName}">${groupName}</option>`;
  gsel.disabled = false;
}

// CALCULATION
function calcBalance() {
  const val = parseFloat(document.getElementById('pay-chitval').value) || 0;
  const paid = parseFloat(document.getElementById('pay-amount').value) || 0;
  document.getElementById('pay-balance').value = Math.max(0, val - paid);
}

// SAVE
async function savePayment() {
  const data = {
    member_id: document.getElementById('pay-member-id').value,
    group_name: document.getElementById('pay-group').value,
    amount_paid: parseFloat(document.getElementById('pay-amount').value),
    balance_amt: parseFloat(document.getElementById('pay-balance').value),
    paid_on: new Date().toISOString()
  };

  if(!data.member_id) return alert("Select a member");

  try {
    await fetch(`${SB_URL}/rest/v1/payments`, {
      method:'POST', headers:H, body:JSON.stringify(data)
    });
    alert("Payment Saved!");
    closeModal('paymentModal');
  } catch(e) { alert("Error saving"); }
}

function openPaymentModal(){ document.getElementById('paymentModal').classList.add('open'); }
function closeModal(id){ document.getElementById(id).classList.remove('open'); }

// Click outside to close search
document.addEventListener('click', (e) => {
  if (!e.target.closest('.form-group')) document.getElementById('search-results').style.display = 'none';
});

init();
</script>
</body>
</html>
