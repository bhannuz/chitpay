<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>AK Chit Funds - Pro Admin</title>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;600;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0a0f1e;--surface:#111827;--surface2:#1a2235;
  --accent:#f59e0b;--text:#f1f5f9;--muted:#64748b;
  --border:rgba(255,255,255,0.08);
  --gold:linear-gradient(135deg,#f59e0b,#fbbf24,#d97706);
  --green:#10b981;--red:#ef4444;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{font-family:'Sora',sans-serif;background:var(--bg);color:var(--text);max-width:430px;margin:0 auto;min-height:100vh;overflow-x:hidden;}

/* NAVIGATION */
.topbar{position:sticky;top:0;z-index:100;background:rgba(10,15,30,.97);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);padding:12px 20px;display:flex;align-items:center;justify-content:space-between;}
.brand-name{font-size:17px;font-weight:800;background:var(--gold);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.page{display:none;animation:fadeUp .3s ease;}
.page.active{display:block;}
@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
.content{padding:20px 20px 180px;}

/* CARDS */
.card{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:20px;margin-bottom:16px;}
.stats-row{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:20px;}
.stat-box{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:14px 10px;text-align:center;}
.stat-val{font-size:16px;font-weight:800;font-family:'JetBrains Mono',monospace;}

/* MODALS */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);backdrop-filter:blur(8px);z-index:200;display:none;align-items:flex-end;justify-content:center;}
.modal-overlay.open{display:flex;}
.modal{background:var(--surface);border-radius:24px 24px 0 0;width:100%;max-width:430px;padding:24px;max-height:85vh;overflow-y:auto;border-top:1px solid var(--border);}
.form-input{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:14px;color:var(--text);font-family:inherit;outline:none;margin-bottom:12px;font-size:14px;}
.form-input:disabled{opacity:0.4; cursor:not-allowed; background:rgba(255,255,255,0.05);}

/* TABLES & BADGES */
.table-wrap{overflow-x:auto; margin-top:10px; border-radius:12px; border:1px solid var(--border);}
table{width:100%; border-collapse:collapse; font-size:11px; text-align:left;}
th{background:var(--surface2); padding:10px; color:var(--muted); text-transform:uppercase; font-size:9px;}
td{padding:10px; border-bottom:1px solid var(--border);}
.picked-badge{display:inline-block; background:rgba(16,185,129,0.15); color:var(--green); font-size:8px; font-weight:800; padding:2px 6px; border-radius:4px; border:1px solid var(--green);}

/* BOTTOM NAV */
.bottom-nav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:430px;background:rgba(17,24,39,.97);backdrop-filter:blur(20px);border-top:1px solid var(--border);display:flex;flex-direction:column;z-index:100;}
.quick-add-bar{display:flex;gap:8px;padding:8px 12px;background:rgba(10,15,30,0.95);border-bottom:1px solid var(--border);}
.quick-btn{flex:1;display:flex;align-items:center;justify-content:center;gap:6px;padding:10px;border-radius:12px;font-size:12px;font-weight:700;cursor:pointer;border:1px solid;}
.quick-btn.member{background:rgba(245,158,11,0.08); border-color:rgba(245,158,11,0.3); color:var(--accent);}
.quick-btn.group{background:rgba(16,185,129,0.08); border-color:rgba(16,185,129,0.3); color:var(--green);}
.bottom-nav-btns{display:flex;padding:8px 0 calc(8px + env(safe-area-inset-bottom));}
.nav-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;cursor:pointer;}
.nav-label{font-size:10px;font-weight:500;color:var(--muted);}
.nav-item.active .nav-label{color:var(--accent);}
</style>
</head>
<body>

<div class="topbar"><div class="brand-name">üèÜ AK Chit Funds</div></div>

<div class="page active" id="page-home">
  <div class="content">
    <div style="font-size:22px;font-weight:800;margin-bottom:15px;">Dashboard</div>
    <div class="stats-row">
      <div class="stat-box"><div class="stat-val" id="st-members">0</div><div style="font-size:8px;color:var(--muted)">Unique</div></div>
      <div class="stat-box"><div class="stat-val" id="st-groups">0</div><div style="font-size:8px;color:var(--muted)">Groups</div></div>
      <div class="stat-box"><div class="stat-val" id="st-payments" style="color:var(--green)">‚Çπ0</div><div style="font-size:8px;color:var(--muted)">Collections</div></div>
    </div>

    <button class="primary-btn" onclick="openModal('payModal')" style="width:100%; padding:18px; border:none; border-radius:18px; background:linear-gradient(135deg,#f59e0b,#d97706); color:#000; font-weight:800; cursor:pointer; margin-bottom:20px;">üí≥ New Payment</button>

    <div class="card">
        <label style="display:block; font-size:11px; color:var(--muted); margin-bottom:10px; font-weight:700;">CONSOLIDATED MEMBER SUMMARY</label>
        <select id="homeMemberSelect" class="form-input" onchange="onHomeMemberChange()" style="margin-bottom:0;">
            <option value="">-- Select Member --</option>
        </select>
    </div>
    <div id="memberPanel"></div>
  </div>
</div>

<div class="page" id="page-groups">
  <div class="content">
    <div style="font-size:22px;font-weight:800;margin-bottom:20px;">Group Aggregates</div>
    <div id="groupReportContainer"></div>
  </div>
</div>

<div class="modal-overlay" id="payModal">
  <div class="modal">
    <div style="font-size:18px; font-weight:800; margin-bottom:20px;">Record Receipt</div>
    <label style="display:block; font-size:11px; color:var(--muted); margin-bottom:8px; font-weight:700;">MEMBER SEARCH</label>
    <input type="text" id="search-input" class="form-input" placeholder="Type name..." oninput="doSearch()" onfocus="showResults()">
    <div id="search-results" style="display:none; background:var(--surface2); border:1px solid var(--border); border-radius:12px; margin-bottom:12px; max-height:150px; overflow-y:auto;"></div>
    
    <label style="display:block; font-size:11px; color:var(--muted); margin-bottom:8px; font-weight:700;">GROUP (DEPENDENT)</label>
    <select id="member-group" class="form-input" onchange="checkGroupHistory()" disabled></select>
    
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
        <div><label style="display:block; font-size:11px; color:var(--muted); margin-bottom:8px; font-weight:700;">CHIT VAL</label><input type="number" id="inp-chitval" class="form-input" placeholder="0" oninput="calcBal()"></div>
        <div><label style="display:block; font-size:11px; color:var(--muted); margin-bottom:8px; font-weight:700;">PAID AMT</label><input type="number" id="inp-paid" class="form-input" placeholder="0" oninput="calcBal()"></div>
    </div>
    
    <input type="number" id="inp-bal" class="form-input" placeholder="Balance" style="color:var(--accent); font-weight:700;" readonly>

    <div style="display:flex; align-items:center; gap:10px; background:var(--surface2); padding:15px; border-radius:12px; margin-bottom:20px;">
        <input type="checkbox" id="inp-picked" style="width:20px; height:20px;">
        <label for="inp-picked" style="font-size:13px; font-weight:600;">Chit Picked this month?</label>
    </div>
    <div id="picked-lock-msg" style="display:none; color:var(--red); font-size:10px; font-weight:700; text-transform:uppercase; margin-top:-15px; margin-bottom:15px; text-align:center;">‚ö†Ô∏è Member already picked chit in this group. Locked.</div>
    
    <button class="primary-btn" style="width:100%; background:var(--gold); border:none; border-radius:14px; padding:16px; color:#000; font-weight:800; cursor:pointer;" onclick="savePayment()">‚úì Save Record</button>
    <button class="secondary-btn" style="width:100%; background:var(--surface2); border:1px solid var(--border); border-radius:14px; padding:13px; color:var(--text); margin-top:10px; cursor:pointer;" onclick="closeModal('payModal')">Cancel</button>
  </div>
</div>

<nav class="bottom-nav">
  <div class="quick-add-bar">
    <div class="quick-btn member" onclick="alert('Feature restored in full menu')">‚ûï Member</div>
    <div class="quick-btn group" onclick="alert('Feature restored in full menu')">üè¶ Group</div>
  </div>
  <div class="bottom-nav-btns">
    <div class="nav-item active" onclick="navigate('home', this)"><span style="font-size:18px;">üè†</span><span class="nav-label">Home</span></div>
    <div class="nav-item" onclick="navigate('groups', this)"><span style="font-size:18px;">üìÇ</span><span class="nav-label">Groups</span></div>
  </div>
</nav>

<script>
const SB_URL='https://fxmulysdirqrkixdqusg.supabase.co';
const SB_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ4bXVseXNkaXJxcmtpeGRxdXNnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NDEzMTMsImV4cCI6MjA4NzQxNzMxM30.Vlptcq0oI5-oA4CtpshjqAvG_yEM-t1TuXfKXpfxgf4';
const H={'Content-Type':'application/json','apikey':SB_KEY,'Authorization':'Bearer '+SB_KEY};

let members=[], payments=[], groups=[], currentSelName='';

async function init(){
  try {
    const [rm, rp, rg] = await Promise.all([
      fetch(`${SB_URL}/rest/v1/members?select=*`,{headers:H}).then(r=>r.json()),
      fetch(`${SB_URL}/rest/v1/payments?select=*`,{headers:H}).then(r=>r.json()),
      fetch(`${SB_URL}/rest/v1/groups?select=*`,{headers:H}).then(r=>r.json())
    ]);
    members=rm; payments=rp; groups=rg;
    
    const uniqueNames = [...new Set(members.map(m => m.name))];
    document.getElementById('st-members').textContent = uniqueNames.length;
    document.getElementById('st-groups').textContent = groups.length;
    const total = payments.reduce((s, p) => s + (p.amount_paid || 0), 0);
    document.getElementById('st-payments').textContent = `‚Çπ${(total/1000).toFixed(1)}K`;
    
    const mSel = document.getElementById('homeMemberSelect');
    mSel.innerHTML = '<option value="">-- Select Member --</option>';
    uniqueNames.sort().forEach(n => mSel.innerHTML += `<option value="${n}">${n}</option>`);
    renderGroupSummary();
  } catch(e) { console.error(e); }
}

function navigate(p, el) {
  document.querySelectorAll('.page').forEach(x => x.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active'));
  document.getElementById('page-'+p).classList.add('active');
  el.classList.add('active');
}

// MEMBER SUMMARY WITH STATUS BADGE
function onHomeMemberChange() {
    const name = document.getElementById('homeMemberSelect').value;
    const panel = document.getElementById('memberPanel');
    if(!name) { panel.innerHTML = ''; return; }
    const mRecords = members.filter(m => m.name === name);
    const mPays = payments.filter(p => mRecords.some(r => r.id === p.member_id));
    
    panel.innerHTML = `
        <div class="card" style="margin-top:15px;">
            <div style="font-size:16px; font-weight:800; margin-bottom:12px;">${name} History</div>
            <div class="table-wrap">
                <table>
                    <thead><tr><th>Group</th><th>Date</th><th>Paid</th><th>Status</th></tr></thead>
                    <tbody>${mPays.map(p => `<tr><td><b>${p.group_name}</b></td><td>${new Date(p.paid_on).toLocaleDateString()}</td><td>‚Çπ${p.amount_paid}</td><td>${p.chit_picked==='Yes' ? '<span class="picked-badge">CHIT PICKED</span>' : 'Monthly'}</td></tr>`).join('')}</tbody>
                </table>
            </div>
        </div>`;
}

// GROUP SUMMARY AGGREGATION
function renderGroupSummary() {
    const container = document.getElementById('groupReportContainer');
    container.innerHTML = groups.map(g => {
        const gMembers = members.filter(m => m.group_name === g.name);
        const gPays = payments.filter(p => p.group_name === g.name);
        const total = gPays.reduce((s,p) => s + (p.amount_paid || 0), 0);
        return `<div class="card" onclick="toggleGroup('${g.id}')">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div style="font-weight:800;">üìÇ ${g.name}</div>
                <div style="color:var(--green); font-weight:800;">‚Çπ${total.toLocaleString()}</div>
            </div>
            <div id="g-agg-${g.id}" style="display:none; margin-top:15px; border-top:1px solid var(--border); padding-top:10px;">
                <div class="table-wrap">
                    <table><thead><tr><th>Member</th><th>Paid</th><th>Status</th></tr></thead>
                    <tbody>${gMembers.map(m => {
                        const mPaid = gPays.filter(p => p.member_id === m.id).reduce((s,p) => s+(p.amount_paid||0), 0);
                        const isPicked = gPays.some(p => p.member_id === m.id && p.chit_picked === 'Yes');
                        return `<tr><td>${m.name}</td><td>‚Çπ${mPaid.toLocaleString()}</td><td>${isPicked ? '‚úÖ' : '-'}</td></tr>`;
                    }).join('')}</tbody></table>
                </div>
            </div>
        </div>`;
    }).join('');
}

function toggleGroup(id){ const el = document.getElementById('g-agg-'+id); el.style.display = el.style.display === 'none' ? 'block' : 'none'; }

// NEW PAYMENT - SAFETY VALIDATION
function doSearch(){
  const q = document.getElementById('search-input').value.toLowerCase();
  const names = [...new Set(members.map(m => m.name))].filter(n => n.toLowerCase().includes(q));
  document.getElementById('search-results').style.display='block';
  document.getElementById('search-results').innerHTML = names.map(n => `<div class="search-item" onclick="selectSearch('${n.replace(/'/g,"")}')" style="padding:12px; border-bottom:1px solid var(--border);">${n}</div>`).join('');
}
function showResults(){ document.getElementById('search-results').style.display='block'; doSearch(); }
function selectSearch(n){
  currentSelName = n;
  document.getElementById('search-input').value = n;
  const gsel = document.getElementById('member-group');
  gsel.disabled = false; gsel.innerHTML = '';
  members.filter(m => m.name === n).forEach(m => {
    const opt = document.createElement('option'); opt.value = m.group_name; opt.textContent = m.group_name;
    gsel.appendChild(opt);
  });
  document.getElementById('search-results').style.display = 'none';
  checkGroupHistory();
}

// CHECK IF CHIT ALREADY PICKED
function checkGroupHistory() {
    const groupName = document.getElementById('member-group').value;
    const mRecords = members.filter(m => m.name === currentSelName && m.group_name === groupName);
    const hasPicked = payments.some(p => mRecords.some(r => r.id === p.member_id) && p.group_name === groupName && p.chit_picked === 'Yes');
    
    const pickedChk = document.getElementById('inp-picked');
    const lockMsg = document.getElementById('picked-lock-msg');
    
    if(hasPicked) {
        pickedChk.checked = false;
        pickedChk.disabled = true;
        lockMsg.style.display = 'block';
    } else {
        pickedChk.disabled = false;
        lockMsg.style.display = 'none';
    }
}

function calcBal(){
    const v = parseFloat(document.getElementById('inp-chitval').value)||0;
    const p = parseFloat(document.getElementById('inp-paid').value)||0;
    document.getElementById('inp-bal').value = Math.max(0, v - p);
}

async function savePayment(){
    const name = document.getElementById('search-input').value;
    const group = document.getElementById('member-group').value;
    const m = members.find(x => x.name === name && x.group_name === group);
    if(!m) return alert("Select member and group");
    
    const data = { 
        member_id: m.id, 
        group_name: group, 
        chit_value: parseFloat(document.getElementById('inp-chitval').value)||0,
        amount_paid: parseFloat(document.getElementById('inp-paid').value)||0,
        balance_amt: parseFloat(document.getElementById('inp-bal').value)||0,
        chit_picked: document.getElementById('inp-picked').checked ? 'Yes' : 'No',
        paid_on: new Date().toISOString() 
    };
    
    await fetch(`${SB_URL}/rest/v1/payments`, { method:'POST', headers:H, body:JSON.stringify(data) });
    alert("Record Saved!"); location.reload();
}

function openModal(id){ document.getElementById(id).classList.add('open'); }
function closeModal(id){ document.getElementById(id).classList.remove('open'); }
init();
</script>
</body>
</html>
