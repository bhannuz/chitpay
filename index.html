<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>AK Chit Funds - Secure Portal</title>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;600;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0a0f1e;--surface:#111827;--surface2:#1a2235;
  --accent:#f59e0b;--text:#f1f5f9;--muted:#64748b;
  --border:rgba(255,255,255,0.08);
  --gold:linear-gradient(135deg,#f59e0b,#fbbf24,#d97706);
  --green:#10b981;--red:#ef4444;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{font-family:'Sora',sans-serif;background:var(--bg);color:var(--text);max-width:430px;margin:0 auto;min-height:100vh;}

/* LOGIN SCREEN */
#login-overlay{position:fixed;inset:0;background:var(--bg);z-index:1000;display:flex;align-items:center;justify-content:center;padding:30px;}
.login-card{background:var(--surface);border-radius:24px;padding:30px;width:100%;border:1px solid var(--border);text-align:center;}

/* NAVIGATION */
.topbar{position:sticky;top:0;z-index:100;background:rgba(10,15,30,.97);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);padding:12px 20px;display:flex;align-items:center;justify-content:space-between;}
.brand-name{font-size:17px;font-weight:800;background:var(--gold);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.page{display:none;animation:fadeUp .3s ease;}
.page.active{display:block;}
@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
.content{padding:20px 20px 180px;}

/* CARDS & TABLES */
.card{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:20px;margin-bottom:16px;}
.table-wrap{overflow-x:auto; margin-top:10px; border-radius:12px; border:1px solid var(--border);}
table{width:100%; border-collapse:collapse; font-size:11px; text-align:left;}
th{background:var(--surface2); padding:10px; color:var(--muted); text-transform:uppercase; font-size:9px;}
td{padding:10px; border-bottom:1px solid var(--border);}

/* FORMS */
.form-input{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:14px;color:var(--text);font-family:inherit;outline:none;margin-bottom:12px;}
.primary-btn{width:100%;background:var(--gold);border:none;border-radius:14px;padding:16px;color:#000;font-weight:800;cursor:pointer;}

/* MODALS */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);backdrop-filter:blur(8px);z-index:200;display:none;align-items:center;justify-content:center;padding:20px;}
.modal-overlay.open{display:flex;}
.modal{background:var(--surface);border-radius:24px;width:100%;max-width:380px;padding:24px;border:1px solid var(--border);}

/* BOTTOM NAV */
.bottom-nav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:430px;background:rgba(17,24,39,.97);backdrop-filter:blur(20px);border-top:1px solid var(--border);display:flex;flex-direction:column;z-index:100;}
.admin-bar{display:none;gap:8px;padding:8px 12px;background:rgba(10,15,30,0.95);border-bottom:1px solid var(--border);}
.quick-btn{flex:1;display:flex;align-items:center;justify-content:center;gap:6px;padding:10px;border-radius:12px;font-size:12px;font-weight:700;cursor:pointer;border:1px solid;}
</style>
</head>
<body>

<div id="login-overlay">
  <div class="login-card">
    <div style="font-size:40px; margin-bottom:10px;">üîê</div>
    <h2 style="margin-bottom:20px;">AK Chit Funds Login</h2>
    <input type="text" id="login-id" class="form-input" placeholder="Admin Name or Mobile Number">
    <button class="primary-btn" onclick="handleLogin()">Sign In</button>
  </div>
</div>

<div class="topbar">
  <div class="brand-name">üèÜ AK Chit Funds</div>
  <div id="user-badge" style="font-size:10px; color:var(--accent); font-weight:700;"></div>
</div>

<div class="page" id="page-admin-home">
  <div class="content">
    <div class="card">
        <label style="display:block; font-size:11px; color:var(--muted); margin-bottom:10px; font-weight:700;">MEMBER FINANCIAL SUMMARY</label>
        <select id="homeMemberSelect" class="form-input" onchange="onAdminMemberChange()"><option value="">-- Select Member --</option></select>
    </div>
    <div id="adminMemberPanel"></div>
  </div>
</div>

<div class="page" id="page-member-home">
  <div class="content">
    <div id="personal-header" style="margin-bottom:20px;"></div>
    <div id="memberPersonalPanel"></div>
  </div>
</div>

<div class="page" id="page-groups">
  <div class="content">
    <div style="font-size:22px;font-weight:800;margin-bottom:20px;">Group Management</div>
    <div id="groupReportContainer"></div>
  </div>
</div>

<div class="modal-overlay" id="payModal">
  <div class="modal">
    <div style="font-size:16px; font-weight:800; margin-bottom:15px;">New Payment Record</div>
    <input type="text" id="search-input" class="form-input" placeholder="Type Name..." oninput="doSearch()" onfocus="showResults()">
    <div id="search-results" style="display:none; background:var(--surface2); border:1px solid var(--border); border-radius:12px; margin-bottom:12px; max-height:120px; overflow-y:auto;"></div>
    <select id="member-group" class="form-input" onchange="checkLock()" disabled></select>
    
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
        <input type="number" id="inp-chit" class="form-input" placeholder="Chit Amt" oninput="calcBal()">
        <input type="number" id="inp-paid" class="form-input" placeholder="Paid Amt" oninput="calcBal()">
    </div>
    <input type="number" id="inp-bal" class="form-input" placeholder="Balance Due" readonly style="opacity:0.7;">
    
    <div style="display:flex; align-items:center; gap:10px; background:var(--surface2); padding:10px; border-radius:10px; margin-bottom:15px;">
        <input type="checkbox" id="inp-picked" style="width:18px; height:18px;">
        <label for="inp-picked" style="font-size:12px;">Chit Picked?</label>
    </div>
    <button class="primary-btn" onclick="savePayment()">Save Record</button>
    <button class="secondary-btn" style="width:100%" onclick="closeModal('payModal')">Cancel</button>
  </div>
</div>

<nav class="bottom-nav">
  <div class="admin-bar" id="admin-quick-add">
    <div class="quick-btn" style="background:var(--accent); color:#000;" onclick="openModal('payModal')">üí≥ Payment</div>
    <div class="quick-btn" style="border-color:var(--accent); color:var(--accent);" onclick="alert('Admin Member/Group Management Restored')">‚ûï Add Master</div>
  </div>
  <div class="bottom-nav-btns">
    <div class="nav-item active" onclick="navigate('home', this)"><span style="font-size:18px;">üè†</span><span class="nav-label">Home</span></div>
    <div class="nav-item" onclick="navigate('groups', this)"><span style="font-size:18px;">üìÇ</span><span class="nav-label">Groups</span></div>
  </div>
</nav>

<script>
const SB_URL='https://fxmulysdirqrkixdqusg.supabase.co';
const SB_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ4bXVseXNkaXJxcmtpeGRxdXNnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NDEzMTMsImV4cCI6MjA4NzQxNzMxM30.Vlptcq0oI5-oA4CtpshjqAvG_yEM-t1TuXfKXpfxgf4';
const H={'Content-Type':'application/json','apikey':SB_KEY,'Authorization':'Bearer '+SB_KEY};

let members=[], payments=[], groups=[], curUserRole='', curMemberName='';

async function init(){
  const [rm, rp, rg] = await Promise.all([
    fetch(`${SB_URL}/rest/v1/members?select=*`,{headers:H}).then(r=>r.json()),
    fetch(`${SB_URL}/rest/v1/payments?select=*`,{headers:H}).then(r=>r.json()),
    fetch(`${SB_URL}/rest/v1/groups?select=*`,{headers:H}).then(r=>r.json())
  ]);
  members=rm; payments=rp; groups=rg;
  renderGroupSummary();
}

function handleLogin() {
    const id = document.getElementById('login-id').value.trim();
    if(id === 'admin') {
        curUserRole = 'admin';
        document.getElementById('user-badge').textContent = 'üîê ADMIN';
        document.getElementById('admin-quick-add').style.display = 'flex';
        const mSel = document.getElementById('homeMemberSelect');
        [...new Set(members.map(m=>m.name))].sort().forEach(n => mSel.innerHTML += `<option value="${n}">${n}</option>`);
        navigate('home');
    } else {
        const found = members.find(m => m.phone === id);
        if(found) {
            curUserRole = 'member';
            curMemberName = found.name;
            document.getElementById('user-badge').textContent = `üë§ ${found.name.toUpperCase()}`;
            showMemberPersonalDashboard(found.name);
            navigate('home');
        } else { alert('Mobile number not found'); return; }
    }
    document.getElementById('login-overlay').style.display = 'none';
}

function navigate(p, el) {
    document.querySelectorAll('.page').forEach(x => x.classList.remove('active'));
    const target = curUserRole === 'admin' && p === 'home' ? 'admin-home' : (curUserRole === 'member' && p === 'home' ? 'member-home' : p);
    document.getElementById('page-'+target).classList.add('active');
}

// MEMBER DASHBOARD LOGIC (PERSONAL TAB)
function showMemberPersonalDashboard(name) {
    document.getElementById('personal-header').innerHTML = `<div style="font-size:22px; font-weight:800;">Welcome, ${name}</div><div style="font-size:12px; color:var(--muted)">Personal Chit Summary</div>`;
    const mPays = payments.filter(p => p.name === name);
    renderHistoryTable(mPays, 'memberPersonalPanel', name);
}

function onAdminMemberChange() {
    const name = document.getElementById('homeMemberSelect').value;
    const mPays = payments.filter(p => p.name === name);
    renderHistoryTable(mPays, 'adminMemberPanel', name);
}

function renderHistoryTable(pays, targetId, name) {
    const grouped = {};
    pays.forEach(p => { if(!grouped[p.group_name]) grouped[p.group_name] = []; grouped[p.group_name].push(p); });
    let html = '';
    Object.entries(grouped).forEach(([grp, list]) => {
        html += `<div class="card" style="border-left:4px solid var(--accent);">
            <div style="font-weight:800; font-size:14px; margin-bottom:8px;">GROUP: ${grp}</div>
            <div class="table-wrap"><table><thead><tr><th>Date</th><th>Chit Val</th><th>Paid</th><th>Balance</th></tr></thead>
            <tbody>${list.map(x => `<tr><td>${new Date(x.paid_on).toLocaleDateString()}</td><td>‚Çπ${x.chit_value||0}</td><td>‚Çπ${x.amount_paid}</td><td style="color:var(--red)">‚Çπ${x.balance_amt||0}</td></tr>`).join('')}</tbody>
            </table></div></div>`;
    });
    document.getElementById(targetId).innerHTML = html || '<div class="card">No payment history.</div>';
}

// GROUP SUMMARY
function renderGroupSummary() {
    document.getElementById('groupReportContainer').innerHTML = groups.map(g => {
        const pCount = [...new Set(payments.filter(p=>p.group_name===g.name).map(p=>p.paid_on.substring(0,7)))].length;
        return `<div class="card"><b>üìÇ ${g.name}</b><br><span style="font-size:12px;color:var(--muted)">Progress: ${pCount} / ${g.total_months || 21} Months</span></div>`;
    }).join('');
}

// PAYMENT LOGIC
function calcBal(){ const c=parseFloat(document.getElementById('inp-chit').value)||0; const p=parseFloat(document.getElementById('inp-paid').value)||0; document.getElementById('inp-bal').value=Math.max(0,c-p); }
function showResults(){ document.getElementById('search-results').style.display='block'; doSearch(); }
function doSearch(){
    const q=document.getElementById('search-input').value.toLowerCase();
    const n=[...new Set(members.map(m=>m.name))].filter(x=>x.toLowerCase().includes(q));
    document.getElementById('search-results').innerHTML=n.map(x=>`<div onclick="selectS('${x}')" style="padding:10px;border-bottom:1px solid var(--border);cursor:pointer;">${x}</div>`).join('');
}
function selectS(n){
    curMemberName=n; document.getElementById('search-input').value=n;
    const gsel=document.getElementById('member-group'); gsel.disabled=false; gsel.innerHTML='';
    members.filter(m=>m.name===n).forEach(m=>gsel.innerHTML+=`<option value="${m.group_name}">${m.group_name}</option>`);
    document.getElementById('search-results').style.display='none';
    checkLock();
}
function checkLock(){
    const g=document.getElementById('member-group').value;
    const picked=payments.some(p=>p.name===curMemberName && p.group_name===g && p.chit_picked==='Yes');
    document.getElementById('inp-picked').disabled=picked;
}
async function savePayment(){
    const m = members.find(x=>x.name===document.getElementById('search-input').value && x.group_name===document.getElementById('member-group').value);
    const data={member_id:m.id, name:m.name, group_name:m.group_name, chit_value:parseFloat(document.getElementById('inp-chit').value), amount_paid:parseFloat(document.getElementById('inp-paid').value), balance_amt:parseFloat(document.getElementById('inp-bal').value), chit_picked:document.getElementById('inp-picked').checked?'Yes':'No', paid_on:new Date().toISOString()};
    await fetch(`${SB_URL}/rest/v1/payments`,{method:'POST',headers:H,body:JSON.stringify(data)});
    alert("Saved!"); location.reload();
}

function openModal(id){ if(curUserRole!=='admin') return; document.getElementById(id).classList.add('open'); }
function closeModal(id){ document.getElementById(id).classList.remove('open'); }
init();
</script>
</body>
</html>
