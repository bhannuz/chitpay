<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>AK Chit Funds - WhatsApp Pro</title>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0a0f1e;--surface:#111827;--surface2:#1a2235;
  --accent:#f59e0b;--text:#f1f5f9;--muted:#64748b;
  --border:rgba(255,255,255,0.08);
  --gold:linear-gradient(135deg,#f59e0b,#fbbf24,#d97706);
  --green:#10b981;--red:#ef4444;--wa:#25D366;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{font-family:'Sora',sans-serif;background:var(--bg);color:var(--text);max-width:430px;margin:0 auto;min-height:100vh;}

#login-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.9);z-index:3000;display:flex;align-items:center;justify-content:center;padding:20px;}
.login-card{background:var(--surface);border-radius:24px;padding:25px;width:100%;max-width:280px;border:1px solid var(--border);text-align:center;}

.topbar{position:sticky;top:0;z-index:100;background:rgba(10,15,30,.97);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);padding:12px 20px;display:flex;align-items:center;justify-content:space-between;}
.brand-name{font-weight:800;background:var(--gold);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-size:16px;}
.logout-btn{background:rgba(239,68,68,0.1); border:1px solid var(--red); color:var(--red); padding:5px 12px; border-radius:8px; font-size:10px; font-weight:700; cursor:pointer;}

.page{display:none;}
.page.active{display:block; animation:fadeUp .3s ease;}
@keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.content{padding:20px 20px 180px;}

.stats-row{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:20px;}
.stat-box{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:14px 10px;text-align:center;}
.stat-val{font-size:14px;font-weight:800;font-family:'JetBrains Mono',monospace;}

.pay-big-btn{width:100%;background:linear-gradient(135deg,#f59e0b,#d97706);border:none;border-radius:18px;padding:18px;color:#000;font-weight:800;cursor:pointer;margin-bottom:20px;display:flex;align-items:center;gap:12px;}
.primary-btn{width:100%;background:var(--gold);border:none;border-radius:14px;padding:16px;color:#000;font-weight:800;cursor:pointer;font-family:inherit;}
.secondary-btn{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:14px;padding:12px;color:var(--text);margin-top:10px;cursor:pointer;}
.wa-btn{background:rgba(37,211,102,0.1); border:1px solid var(--wa); color:var(--wa); border-radius:12px; padding:10px; cursor:pointer; font-weight:700; font-size:11px; display:flex; align-items:center; gap:8px;}

.table-wrap{overflow-x:auto; margin-top:10px; border-radius:12px; border:1px solid var(--border);}
table{width:100%; border-collapse:collapse; font-size:9px; text-align:left;}
th{background:var(--surface2); padding:10px; color:var(--muted); text-transform:uppercase; font-size:8px;}
td{padding:10px; border-bottom:1px solid var(--border);}

.card{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:15px;margin-bottom:16px;}
.form-input{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:12px;color:var(--text);font-family:inherit;outline:none;margin-bottom:10px;font-size:13px;}

.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.85);backdrop-filter:blur(8px);z-index:1500;display:none;align-items:center;justify-content:center;padding:20px;}
.modal-overlay.open{display:flex;}
.modal{background:var(--surface);border-radius:24px;width:100%;max-width:380px;padding:24px;border:1px solid var(--border);}
</style>
</head>
<body>

<div id="login-overlay">
  <div class="login-card">
    <div style="font-size:30px; margin-bottom:10px;">üîê</div>
    <h3 style="margin-bottom:15px;">AK Funds</h3>
    <input type="text" id="login-id" class="form-input" placeholder="Name or Mobile No">
    <button class="primary-btn" onclick="handleLogin()" style="width:100%;">Sign In</button>
  </div>
</div>

<div class="topbar">
  <div class="brand-name">üèÜ AK Chit Funds</div>
  <div style="display:flex; align-items:center; gap:10px;">
    <div id="user-badge" style="font-size:9px; color:var(--accent); font-weight:700;"></div>
    <button class="logout-btn" onclick="logout()">LOGOUT</button>
  </div>
</div>

<div class="page" id="page-admin-home">
  <div class="content">
    <div class="stats-row">
      <div class="stat-box"><div class="stat-val" id="st-members">0</div><div style="font-size:9px;color:var(--muted)">Members</div></div>
      <div class="stat-box"><div class="stat-val" id="st-groups">0</div><div style="font-size:9px;color:var(--muted)">Groups</div></div>
      <div class="stat-box"><div class="stat-val" id="st-today" style="color:var(--green)">‚Çπ0</div><div style="font-size:9px;color:var(--muted)">Today</div></div>
    </div>
    <button class="pay-big-btn" onclick="openModal('payModal')">
      <div style="background:rgba(0,0,0,0.1); padding:10px; border-radius:12px;">üí≥</div>
      <div style="text-align:left;"><div style="font-size:16px;">New Payment</div><div style="font-size:10px; opacity:0.7;">Record monthly receipt</div></div>
    </button>
    <div class="card"><select id="homeMemberSelect" class="form-input" onchange="onAdminMemberChange()"><option value="">-- Member Summary --</option></select></div>
    <div id="adminMemberPanel"></div>
  </div>
</div>

<div class="page" id="page-member-home">
  <div class="content"><div style="font-size:20px; font-weight:800; margin-bottom:10px;" id="welcome-msg">Welcome</div><div id="memberPersonalPanel"></div></div>
</div>

<div class="page" id="page-groups">
  <div class="content"><div style="font-size:22px;font-weight:800;margin-bottom:20px;">Groups</div><div id="groupReportContainer"></div></div>
</div>

<div class="modal-overlay" id="payModal">
  <div class="modal">
    <div style="font-size:16px; font-weight:800; margin-bottom:15px;">Record Payment</div>
    <input type="date" id="inp-date" class="form-input">
    <div style="position:relative;">
        <input type="text" id="search-input" class="form-input" placeholder="Search Member Name..." oninput="doSearch()" onfocus="showResults()">
        <div id="search-results" style="display:none; background:var(--surface2); border:1px solid var(--border); border-radius:12px; margin-bottom:12px; max-height:120px; overflow-y:auto; position:absolute; width:100%; z-index:200;"></div>
    </div>
    <select id="member-group" class="form-input" onchange="checkLock()" disabled></select>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
        <input type="number" id="inp-chit" class="form-input" placeholder="Chit Amt" oninput="calcBal()">
        <input type="number" id="inp-paid" class="form-input" placeholder="Paid Amt" oninput="calcBal()">
    </div>
    <input type="number" id="inp-bal" class="form-input" placeholder="Balance" readonly style="opacity:0.7;">
    <div style="background:var(--surface2); padding:10px; border-radius:12px; margin-bottom:15px;">
        <div style="display:flex; align-items:center; gap:10px; margin-bottom:5px;">
            <input type="checkbox" id="inp-picked" onchange="togglePickedVal()">
            <label style="font-size:12px;">Chit Picked?</label>
        </div>
        <input type="number" id="inp-picked-val" class="form-input" placeholder="Value Amount" style="display:none;">
    </div>
    <button class="primary-btn" onclick="savePayment()">Save Record</button>
    <button class="secondary-btn" style="width:100%" onclick="closeModal('payModal')">Cancel</button>
  </div>
</div>

<div class="modal-overlay" id="addMemberModal">
    <div class="modal">
        <div style="font-size:16px; font-weight:800; margin-bottom:15px;">Manage Member</div>
        <select id="nm-select" class="form-input" onchange="fillMemberEdit()">
            <option value="new">-- Enroll New Member --</option>
        </select>
        <input type="text" id="nm-name" class="form-input" placeholder="Full Name">
        <select id="nm-group" class="form-input"></select>
        <input type="tel" id="nm-phone" class="form-input" placeholder="Mobile Number">
        <button class="primary-btn" onclick="executeAddMember()">Save Member</button>
        <button class="secondary-btn" style="width:100%" onclick="closeModal('addMemberModal')">Cancel</button>
    </div>
</div>

<nav class="bottom-nav" id="main-nav" style="display:none;">
  <div class="quick-add-bar" id="admin-quick-add">
    <div class="quick-btn" onclick="openModal('addMemberModal')">üë§ Member Master</div>
    <div class="quick-btn" onclick="alert('Manage Groups Modal Logic')">üè¶ Group Master</div>
  </div>
  <div class="bottom-nav-btns">
    <div class="nav-item active" onclick="navigate('home', this)"><span style="font-size:18px;">üè†</span><span class="nav-label">Home</span></div>
    <div class="nav-item" id="groups-nav-item" onclick="navigate('groups', this)"><span style="font-size:18px;">üìÇ</span><span class="nav-label">Groups</span></div>
  </div>
</nav>

<script>
const SB_URL='https://fxmulysdirqrkixdqusg.supabase.co';
const SB_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ4bXVseXNkaXJxcmtpeGRxdXNnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NDEzMTMsImV4cCI6MjA4NzQxNzMxM30.Vlptcq0oI5-oA4CtpshjqAvG_yEM-t1TuXfKXpfxgf4';
const H={'Content-Type':'application/json','apikey':SB_KEY,'Authorization':'Bearer '+SB_KEY};

let members=[], payments=[], groups=[], curRole='', curMName='';

async function refreshData(){
  try {
    const [rm, rp, rg] = await Promise.all([
      fetch(`${SB_URL}/rest/v1/members?select=*`,{headers:H}).then(r=>r.json()),
      fetch(`${SB_URL}/rest/v1/payments?select=*`,{headers:H}).then(r=>r.json()),
      fetch(`${SB_URL}/rest/v1/groups?select=*`,{headers:H}).then(r=>r.json())
    ]);
    members=rm; payments=rp; groups=rg;
    updateUI();
  } catch(e) { console.error("Sync Error"); }
}

function updateUI(){
    document.getElementById('st-members').textContent = members.length;
    document.getElementById('st-groups').textContent = groups.length;
    const today = new Date().toISOString().split('T')[0];
    const tCol = payments.filter(p=>p.paid_on?.startsWith(today)).reduce((s,p)=>s+(p.amount_paid||0),0);
    document.getElementById('st-today').textContent = `‚Çπ${(tCol/1000).toFixed(1)}K`;
    
    if(curRole === 'admin') {
        const mSel = document.getElementById('homeMemberSelect');
        const cur = mSel.value;
        mSel.innerHTML = '<option value="">-- Member Summary --</option>';
        [...new Set(members.map(m=>m.name))].sort().forEach(n => mSel.innerHTML += `<option value="${n}">${n}</option>`);
        mSel.value = cur;

        const mEdSel = document.getElementById('nm-select');
        mEdSel.innerHTML = '<option value="new">-- Enroll New Member --</option>';
        members.forEach(m => mEdSel.innerHTML += `<option value="${m.id}">${m.name} (${m.group_name})</option>`);

        const nmGSel = document.getElementById('nm-group');
        nmGSel.innerHTML = '<option value="">-- Assign Group --</option>';
        groups.forEach(g => nmGSel.innerHTML += `<option value="${g.name}">${g.name}</option>`);
    }
    renderGroupsView();
}

function handleLogin() {
    const id = document.getElementById('login-id').value.trim();
    const nav = document.getElementById('main-nav');
    if(id === 'admin') {
        curRole = 'admin'; nav.style.display = 'flex';
        document.getElementById('admin-quick-add').style.display = 'flex';
        document.getElementById('user-badge').textContent = 'ADMIN';
        navigate('home');
    } else {
        const found = members.find(m => m.phone === id);
        if(found) {
            curRole = 'member'; curMName = found.name; nav.style.display = 'flex';
            document.getElementById('admin-quick-add').style.display = 'none';
            document.getElementById('groups-nav-item').style.display = 'none';
            document.getElementById('user-badge').textContent = found.name.toUpperCase();
            document.getElementById('welcome-msg').textContent = `Welcome, ${found.name}`;
            renderMemberTable(payments.filter(px => px.name === curMName), 'memberPersonalPanel', curMName);
            navigate('home');
        } else { alert('User not found'); return; }
    }
    document.getElementById('login-overlay').style.display = 'none';
    refreshData();
}

function logout() { location.reload(); }

function navigate(p, el) {
    if(el) { document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active')); el.classList.add('active'); }
    document.querySelectorAll('.page').forEach(x => x.classList.remove('active'));
    const target = (curRole === 'admin' && p === 'home') ? 'admin-home' : (curRole === 'member' && p === 'home' ? 'member-home' : p);
    document.getElementById('page-'+target).classList.add('active');
}

// WHATSAPP FEATURE ADDED HERE
function sendWhatsAppSummary(groupName, memberName) {
    const member = members.find(m => m.name === memberName && m.group_name === groupName);
    const group = groups.find(g => g.name === groupName);
    const history = payments.filter(p => p.name === memberName && p.group_name === groupName);
    
    const currentMonth = history.length;
    const totalMonths = group ? group.total_months : 21;
    const latestPayment = history[history.length - 1];
    const balance = latestPayment ? latestPayment.balance_amt : 0;
    const chitValue = latestPayment ? latestPayment.chit_value : 0;

    const message = `*AK CHIT FUNDS - STATEMENT*%0A` +
        `----------------------------%0A` +
        `*Member:* ${memberName}%0A` +
        `*Group Name:* ${groupName}%0A` +
        `*Monthly Value:* ‚Çπ${chitValue}%0A` +
        `*Month Number:* ${currentMonth} of ${totalMonths}%0A` +
        `*Pending Months:* ${totalMonths - currentMonth}%0A` +
        `----------------------------%0A` +
        `*Current Balance:* ‚Çπ${balance}%0A` +
        `----------------------------%0A` +
        `_Please clear dues if any. Thank you!_`;

    window.open(`https://wa.me/91${member.phone}?text=${message}`, '_blank');
}

function renderMemberTable(pays, targetId, name) {
    const grouped = {};
    pays.forEach(p => { if(!grouped[p.group_name]) grouped[p.group_name] = []; grouped[p.group_name].push(p); });
    let html = '';
    Object.entries(grouped).forEach(([gn, list]) => {
        const pk = list.find(x => x.chit_picked === 'Yes');
        const waButton = curRole === 'admin' ? `<button class="wa-btn" onclick="sendWhatsAppSummary('${gn}', '${name}')">üì≤ Share Summary</button>` : '';
        
        html += `<div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                <b style="font-size:13px;">üìÇ ${gn}</b>
                ${waButton}
            </div>
            <div class="table-wrap"><table>
                <thead><tr><th>Date</th><th>Chit Amt</th><th>Paid</th><th>Balance</th><th>Status</th></tr></thead>
                <tbody>${list.map(x=>`<tr><td>${new Date(x.paid_on).toLocaleDateString()}</td><td>‚Çπ${x.chit_value}</td><td>‚Çπ${x.amount_paid}</td><td style="color:var(--accent)">‚Çπ${x.balance_amt}</td><td>${x.chit_picked === 'Yes' ? '<span style="color:var(--green)">PICKED</span>' : '‚Äî'}</td></tr>`).join('')}</tbody>
            </table></div></div>`;
    });
    document.getElementById(targetId).innerHTML = html || 'No data';
}

function onAdminMemberChange() { renderMemberTable(payments.filter(p => p.name === document.getElementById('homeMemberSelect').value), 'adminMemberPanel', document.getElementById('homeMemberSelect').value); }

function renderGroupsView() {
    document.getElementById('groupReportContainer').innerHTML = groups.map(g => {
        const gPays = payments.filter(p => p.group_name === g.name);
        const pCount = [...new Set(gPays.map(p => p.paid_on?.substring(0,7)))].length;
        return `<div class="card" onclick="toggleDetails('${g.id}')">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <b>üìÇ ${g.name}</b>
                <span style="font-size:11px;color:var(--accent);font-weight:700;">${Math.max(0, (g.total_months||21)-pCount)} / ${(g.total_months||21)} MONTHS PENDING</span>
            </div>
            <div id="det-${g.id}" style="display:none;margin-top:15px;border-top:1px solid var(--border);padding-top:10px;">
                <div class="table-wrap"><table><thead><tr><th>Member</th><th>Paid</th><th>Status</th></tr></thead>
                <tbody>${members.filter(m=>m.group_name===g.name).map(m=>{
                    const paid = gPays.filter(px => px.member_id === m.id).reduce((s,p)=>s+p.amount_paid,0);
                    return `<tr><td>${m.name}</td><td>‚Çπ${paid}</td><td>${gPays.some(p=>p.member_id===m.id && p.chit_picked==='Yes')?'PICKED':'-'}</td></tr>`;
                }).join('')}</tbody></table></div>
            </div></div>`;
    }).join('');
}

function toggleDetails(id){ const el=document.getElementById('det-'+id); el.style.display=el.style.display==='none'?'block':'none'; }
function togglePickedVal(){ document.getElementById('inp-picked-val').style.display = document.getElementById('inp-picked').checked?'block':'none'; }
function calcBal(){ const c=parseFloat(document.getElementById('inp-chit').value)||0; const p=parseFloat(document.getElementById('inp-paid').value)||0; document.getElementById('inp-bal').value=Math.max(0,c-p); }

function doSearch(){
    const q = document.getElementById('search-input').value.toLowerCase();
    const n = [...new Set(members.map(m=>m.name))].filter(x=>x.toLowerCase().includes(q));
    document.getElementById('search-results').style.display='block';
    document.getElementById('search-results').innerHTML = n.map(x => `<div class="search-item" onclick="selectS('${x.replace(/'/g,"")}')">${x}</div>`).join('');
}
function showResults(){ document.getElementById('search-results').style.display='block'; doSearch(); }
function selectS(n){
    document.getElementById('search-input').value = n;
    const gsel = document.getElementById('member-group'); gsel.disabled = false; gsel.innerHTML = '';
    members.filter(m=>m.name===n).forEach(m=>gsel.innerHTML+=`<option value="${m.group_name}">${m.group_name}</option>`);
    document.getElementById('search-results').style.display = 'none';
}
function checkLock(){
    const g = document.getElementById('member-group').value;
    const pk = payments.some(p=>p.name===document.getElementById('search-input').value && p.group_name===g && p.chit_picked==='Yes');
    const chk = document.getElementById('inp-picked'); chk.disabled=pk; if(pk) chk.checked=false; togglePickedVal();
}

async function savePayment(){
    const n = document.getElementById('search-input').value, g = document.getElementById('member-group').value, m = members.find(x=>x.name===n && x.group_name===g);
    const data = { member_id: m.id, name: n, group_name: g, chit_value: parseFloat(document.getElementById('inp-chit').value)||0, amount_paid: parseFloat(document.getElementById('inp-paid').value)||0, balance_amt: parseFloat(document.getElementById('inp-bal').value)||0, chit_picked: document.getElementById('inp-picked').checked?'Yes':'No', picked_value: parseFloat(document.getElementById('inp-picked-val').value)||0, paid_on: document.getElementById('inp-date').value };
    await fetch(`${SB_URL}/rest/v1/payments`,{method:'POST',headers:H,body:JSON.stringify(data)});
    alert("Saved!"); closeModal('payModal'); refreshData();
}

function openModal(id){ document.getElementById(id).classList.add('open'); }
function closeModal(id){ document.getElementById(id).classList.remove('open'); }
document.getElementById('inp-date').valueAsDate = new Date();
refreshData();
</script>
</body>
</html>
