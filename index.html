<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>AK Chit Funds - Admin Pro</title>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;600;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0a0f1e;--surface:#111827;--surface2:#1a2235;
  --accent:#f59e0b;--text:#f1f5f9;--muted:#64748b;
  --border:rgba(255,255,255,0.08);
  --gold:linear-gradient(135deg,#f59e0b,#fbbf24,#d97706);
  --green:#10b981;--red:#ef4444;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{font-family:'Sora',sans-serif;background:var(--bg);color:var(--text);max-width:430px;margin:0 auto;min-height:100vh;overflow-x:hidden;}

/* TOPBAR & NAV */
.topbar{position:sticky;top:0;z-index:100;background:rgba(10,15,30,.97);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);padding:12px 20px;display:flex;align-items:center;justify-content:space-between;}
.brand-name{font-size:17px;font-weight:800;background:var(--gold);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.bottom-nav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:430px;background:rgba(17,24,39,.97);backdrop-filter:blur(20px);border-top:1px solid var(--border);display:flex;flex-direction:column;z-index:100;}
.bottom-nav-btns{display:flex;padding:8px 0 calc(8px + env(safe-area-inset-bottom));}
.nav-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;cursor:pointer;}
.nav-label{font-size:10px;font-weight:500;color:var(--muted);}
.nav-item.active .nav-label{color:var(--accent);}

/* LAYOUT */
.content{padding:20px 20px 140px;}
.card{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:20px;margin-bottom:16px;}
.stats-row{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:20px;}
.stat-box{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:14px 10px;text-align:center;}
.stat-val{font-size:18px;font-weight:800;font-family:'JetBrains Mono',monospace;}

/* BUTTONS */
.pay-big-btn{width:100%;background:linear-gradient(135deg,#f59e0b,#d97706);border:none;border-radius:18px;padding:18px;color:#000;font-weight:800;cursor:pointer;margin-bottom:20px;display:flex;align-items:center;gap:15px;}
.primary-btn{width:100%;background:var(--gold);border:none;border-radius:14px;padding:16px;color:#000;font-weight:800;cursor:pointer;font-family:inherit;}
.secondary-btn{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:14px;padding:13px;color:var(--text);margin-top:10px;cursor:pointer;font-family:inherit;}
.wa-btn{background:#25D366; color:#fff; padding:12px; border-radius:12px; text-decoration:none; display:block; font-size:13px; text-align:center; margin-top:10px; font-weight:700;}

/* MODALS */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);backdrop-filter:blur(8px);z-index:200;display:none;align-items:flex-end;justify-content:center;}
.modal-overlay.open{display:flex;}
.modal{background:var(--surface);border-radius:24px 24px 0 0;width:100%;padding:24px;max-height:90vh;overflow-y:auto;border-top:1px solid var(--border);}

/* SEARCH */
#search-results{display:none;position:absolute;top:100%;left:0;right:0;background:var(--surface2);border:1px solid var(--accent);border-radius:12px;z-index:1000;max-height:200px;overflow-y:auto;margin-top:5px;box-shadow:0 10px 25px rgba(0,0,0,0.5);}
.search-item{padding:12px;border-bottom:1px solid var(--border);cursor:pointer;display:flex;justify-content:space-between;align-items:center;}
.picked-tag{background:rgba(239,68,68,0.2);color:var(--red);font-size:9px;padding:2px 6px;border-radius:4px;border:1px solid var(--red);font-weight:800;}

@media print { body * { visibility: hidden; } #invoice-print, #invoice-print * { visibility: visible; } #invoice-print { position: absolute; left: 0; top: 0; width: 100%; background:#fff; color:#000; padding:20px; } }
</style>
</head>
<body>

<div class="topbar">
  <div class="brand-name">üèÜ AK Chit Funds</div>
  <div style="font-size:10px; color:var(--green)">‚óè Master Dependent Mode</div>
</div>

<div class="content" id="main-content">
  <div style="margin-bottom:16px;">
    <div style="font-size:13px;color:var(--muted);">Welcome back üëã</div>
    <div style="font-size:22px;font-weight:800;margin-top:2px;">Bhanu Prasad</div>
  </div>

  <div class="stats-row">
    <div class="stat-box"><div class="stat-val" id="st-members">0</div><div style="font-size:9px;color:var(--muted)">Members</div></div>
    <div class="stat-box"><div class="stat-val" id="st-groups">0</div><div style="font-size:9px;color:var(--muted)">Groups</div></div>
    <div class="stat-box"><div class="stat-val" id="st-payments" style="color:var(--green)">‚Çπ0</div><div style="font-size:9px;color:var(--muted)">Collected</div></div>
  </div>

  <button class="pay-big-btn" onclick="openPayModal()">
    <div style="background:rgba(0,0,0,0.1); padding:10px; border-radius:12px;">üí≥</div>
    <div style="text-align:left;">
      <div style="font-size:16px;">New Payment</div>
      <div style="font-size:11px; opacity:0.7;">Record dependent master entry</div>
    </div>
  </button>

  <div class="card">
    <div style="font-size:11px; color:var(--muted); text-transform:uppercase; margin-bottom:12px; font-weight:700;">üö® Defaulters List</div>
    <div id="defaulter-list" style="font-size:13px;">Syncing data...</div>
  </div>
</div>

<div class="modal-overlay" id="payModal">
  <div class="modal">
    <div id="pay-form-container">
      <div style="font-size:18px; font-weight:800; margin-bottom:20px;">New Receipt</div>
      
      <div style="margin-bottom:16px; position:relative;">
        <label style="display:block; font-size:11px; color:var(--muted); margin-bottom:8px; font-weight:700;">SEARCH MEMBER NAME</label>
        <input type="text" id="search-input" style="width:100%; background:var(--surface2); border:1px solid var(--border); border-radius:12px; padding:14px; color:var(--text); outline:none;" placeholder="Start typing..." autocomplete="off" oninput="doSearch()" onfocus="showResults()">
        <input type="hidden" id="selected-id"><input type="hidden" id="selected-phone">
        <div id="search-results"></div>
      </div>

      <div style="margin-bottom:16px;">
        <label style="display:block; font-size:11px; color:var(--muted); margin-bottom:8px; font-weight:700;">GROUP NAME (LOCKED TO MASTER)</label>
        <select id="member-group" style="width:100%; background:var(--surface2); border:1px solid var(--border); border-radius:12px; padding:14px; color:var(--text);" disabled>
          <option value="">Select member first</option>
        </select>
      </div>

      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:16px;">
        <div><label style="display:block; font-size:11px; color:var(--muted); margin-bottom:8px; font-weight:700;">PAID (‚Çπ)</label><input type="number" id="inp-paid" style="width:100%; background:var(--surface2); border:1px solid var(--border); border-radius:12px; padding:14px; color:var(--text);" oninput="calc()"></div>
        <div><label style="display:block; font-size:11px; color:var(--muted); margin-bottom:8px; font-weight:700;">BALANCE (‚Çπ)</label><input type="number" id="inp-bal" style="width:100%; background:var(--surface2); border:1px solid var(--border); border-radius:12px; padding:14px; color:var(--accent);" readonly></div>
      </div>

      <div style="display:flex; align-items:center; gap:10px; background:var(--surface2); padding:12px; border-radius:12px; margin-bottom:20px;">
        <input type="checkbox" id="inp-picked" style="width:20px; height:20px;">
        <label for="inp-picked" style="font-size:13px; font-weight:600;">Chit Picked this month?</label>
      </div>
      <div id="picked-warning" style="display:none; color:var(--red); font-size:11px; margin-bottom:15px; margin-top:-10px;">‚ö†Ô∏è Member already picked chit. Disabled.</div>

      <button class="primary-btn" id="save-btn" onclick="save()">Save & Finalize</button>
      <button class="secondary-btn" onclick="closeModal()">Cancel</button>
    </div>

    <div id="post-save" style="display:none; text-align:center;">
      <div style="font-size:40px; margin-bottom:10px;">‚úÖ</div>
      <h3 style="margin-bottom:20px;">Record Saved!</h3>
      <a href="#" id="wa-link" class="wa-btn" target="_blank">üí¨ WhatsApp Receipt</a>
      <button class="secondary-btn" style="width:100%" onclick="window.print()">üñ®Ô∏è Print Receipt</button>
      <button class="secondary-btn" style="width:100%" onclick="location.reload()">Return Home</button>
    </div>
  </div>
</div>

<nav class="bottom-nav">
  <div class="bottom-nav-btns">
    <div class="nav-item active"><span style="font-size:20px;">üè†</span><span class="nav-label">Home</span></div>
    <div class="nav-item" onclick="alert('Feature coming soon')"><span style="font-size:20px;">üìÇ</span><span class="nav-label">Groups</span></div>
    <div class="nav-item" onclick="alert('Feature coming soon')"><span style="font-size:20px;">üìä</span><span class="nav-label">Reports</span></div>
  </div>
</nav>

<div id="invoice-print" style="display:none; font-family:monospace;">
  <center><h2>AK CHIT FUNDS</h2><hr></center>
  <p><b>Date:</b> <span id="inv-date"></span></p>
  <p><b>Member:</b> <span id="inv-name"></span></p>
  <p><b>Group:</b> <span id="inv-group"></span></p>
  <hr>
  <p><b>Amount Paid:</b> ‚Çπ<span id="inv-paid"></span></p>
  <p><b>Balance Due:</b> ‚Çπ<span id="inv-bal"></span></p>
  <hr>
  <center><p>Thank you!</p></center>
</div>

<script>
const SB_URL='https://fxmulysdirqrkixdqusg.supabase.co';
const SB_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ4bXVseXNkaXJxcmtpeGRxdXNnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NDEzMTMsImV4cCI6MjA4NzQxNzMxM30.Vlptcq0oI5-oA4CtpshjqAvG_yEM-t1TuXfKXpfxgf4';
const H={'Content-Type':'application/json','apikey':SB_KEY,'Authorization':'Bearer '+SB_KEY};

let members=[], payments=[];

async function init(){
  try {
    const [rm, rp, rg] = await Promise.all([
      fetch(`${SB_URL}/rest/v1/members?select=*`,{headers:H}).then(r=>r.json()),
      fetch(`${SB_URL}/rest/v1/payments?select=*`,{headers:H}).then(r=>r.json()),
      fetch(`${SB_URL}/rest/v1/groups?select=count`,{headers:H}).then(r=>r.json())
    ]);
    members=rm; payments=rp;
    document.getElementById('st-members').textContent=members.length;
    document.getElementById('st-groups').textContent=rg[0]?.count || 0;
    const total = payments.reduce((s, p) => s + (p.amount_paid || 0), 0);
    document.getElementById('st-payments').textContent = `‚Çπ${(total/1000).toFixed(1)}K`;
    renderDefs();
  } catch(e) { console.error(e); }
}

function renderDefs(){
  const bal = {};
  payments.forEach(p => bal[p.member_id] = (bal[p.member_id] || 0) + (p.balance_amt || 0));
  const defs = members.filter(m => bal[m.id] > 0);
  document.getElementById('defaulter-list').innerHTML = defs.map(m => `
    <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid var(--border);">
      <span>${m.name}</span><span style="color:var(--red); font-weight:800;">‚Çπ${bal[m.id].toLocaleString()}</span>
    </div>`).join('') || "No pending balances.";
}

function showResults(){ document.getElementById('search-results').style.display='block'; doSearch(); }
function doSearch(){
  const q = document.getElementById('search-input').value.toLowerCase();
  const container = document.getElementById('search-results');
  const filtered = members.filter(m => m.name.toLowerCase().includes(q));
  container.innerHTML = filtered.map(m => {
    const picked = payments.some(p => p.member_id === m.id && p.chit_picked === 'Yes');
    return `<div class="search-item" onclick="select('${m.id}','${m.name.replace(/'/g,"")}','${m.group_name}','${m.phone}',${picked})">
      <div>${m.name} <small style="display:block;color:var(--muted)">${m.group_name}</small></div>
      ${picked ? '<span class="picked-tag">PICKED</span>' : ''}
    </div>`;
  }).join('');
}

function select(id, name, group, phone, picked){
  document.getElementById('selected-id').value = id;
  document.getElementById('selected-phone').value = phone;
  document.getElementById('search-input').value = name;
  const gsel = document.getElementById('member-group');
  gsel.disabled = false; gsel.innerHTML = `<option value="${group}">${group}</option>`;
  document.getElementById('search-results').style.display = 'none';
  const chk = document.getElementById('inp-picked');
  chk.disabled = picked; chk.checked = false;
  document.getElementById('picked-warning').style.display = picked ? 'block' : 'none';
}

function calc(){
  const p = parseFloat(document.getElementById('inp-paid').value)||0;
  document.getElementById('inp-bal').value = Math.max(0, 20000 - p); // Assuming 20k default, can adjust
}

async function save(){
  const id = document.getElementById('selected-id').value;
  if(!id) return alert("Select member");
  const data = {
    member_id: id,
    group_name: document.getElementById('member-group').value,
    amount_paid: parseFloat(document.getElementById('inp-paid').value) || 0,
    balance_amt: parseFloat(document.getElementById('inp-bal').value) || 0,
    chit_picked: document.getElementById('inp-picked').checked ? 'Yes' : 'No',
    paid_on: new Date().toISOString()
  };
  const res = await fetch(`${SB_URL}/rest/v1/payments`, {
    method:'POST', headers:{...H, 'Prefer':'return=representation'}, body:JSON.stringify(data)
  });
  if(res.ok){
    const msg = `*AK CHIT FUNDS*%0AHello ${document.getElementById('search-input').value},%0AReceived: *‚Çπ${data.amount_paid}*%0ABalance: ‚Çπ${data.balance_amt}`;
    document.getElementById('wa-link').href = `https://wa.me/91${document.getElementById('selected-phone').value}?text=${msg}`;
    document.getElementById('inv-date').textContent = new Date().toLocaleDateString();
    document.getElementById('inv-name').textContent = document.getElementById('search-input').value;
    document.getElementById('inv-group').textContent = data.group_name;
    document.getElementById('inv-paid').textContent = data.amount_paid;
    document.getElementById('inv-bal').textContent = data.balance_amt;
    document.getElementById('pay-form-container').style.display='none';
    document.getElementById('post-save').style.display='block';
  }
}

function openPayModal(){ document.getElementById('payModal').classList.add('open'); }
function closeModal(){ document.getElementById('payModal').classList.remove('open'); }
init();
</script>
</body>
</html>
